function ALList(){this.list=[]}function ConnectionManager(e){this.legion=e,this.serverConnection=null,this.peerConnections=new ALMap;var t=this;this.legion.messagingAPI.setHandlerFor("OfferAsAnswer",function(e,o){t.handleSignalling(e,o)}),this.legion.messagingAPI.setHandlerFor("OfferReturn",function(e,o){t.handleSignalling(e,o)}),this.legion.messagingAPI.setHandlerFor("ICE",function(e,o){t.handleSignalling(e,o)})}function ALMap(){this.map={}}function Legion(e){this.options=e,this.messageCount=Math.floor(Math.random()*Number.MAX_VALUE%Math.pow(10,10)),this.id=this.options.clientID,this.messagingAPI=new MessagingAPI(this),this.options.bullyProtocol&&(this.bullyProtocol=new this.options.bullyProtocol.type(this)),this.overlay=new Overlay(this,this),this.connectionManager=new ConnectionManager(this),this.objectStore=null}function ALQueue(){this.queue=[]}function MessagingAPI(e){this.legion=e,this.messagingProtocol=new this.legion.options.messagingProtocol(this,this.legion),this.callbacks=new ALMap,this.duplicates=new Duplicates}function ALSet(){this.set={}}function ObjectServerConnection(e,t,o){this.server=e,this.objectStore=t,this.legion=o,this.remoteID=this.server.ip+":"+this.server.port,this.socket=new WebSocket("ws://"+this.server.ip+":"+this.server.port);var n=this;this.socket.onopen=function(){n.legion.generateMessage("CLIENT_ID",null,function(e){e.clientID=n.legion.id,n.send(JSON.stringify(e))}),n.legion.connectionManager.onOpenServer(n)},this.socket.onmessage=function(e){var t=JSON.parse(e.data);console.log("Got "+t.type+" from "+n.remoteID+" s: "+t.sender);var o=JSON.parse(e.data);t.content?decompress(t.content,function(e){t.content=JSON.parse(e),n.objectStore.onMessageFromServer(t,o,n)}):n.objectStore.onMessageFromServer(t,o,n)},this.socket.onclose=function(){n.legion.connectionManager.onCloseServer(n)},this.socket.onerror=function(e){console.error("ServerSocket Error",e)}}function compress(e,t){"undefined"!=typeof LZMA?LZMA.compress(e,1,function(e){for(var o="",n=0;n<e.length;n++)o+=fromDecToHex(e[n]);t(o)},function(){}):t(e)}function decompress(e,t){for(var o=[],n=0;n<e.length;n+=2)o.push(fromHexToDec(e[n]+e[n+1]));"undefined"!=typeof LZMA?LZMA.decompress(o,function(e){t(e)},function(){}):t(e)}function ObjectStore(e){this.legion=e,this.types=new ALMap,this.crdts=new ALMap,this.objectServer=null,this.peerSyncs=new ALMap;var t=this;this.handlers={peerSync:{type:"OS:PS",callback:function(e){var o=t.peerSyncs.get(e.sender);o?o.handleSync(e):console.warn("Got OS:PS for unknown peer.")}},peerSyncAnswer:{type:"OS:PSA",callback:function(e){var o=t.peerSyncs.get(e.sender);o?o.handleSyncAnswer(e):console.warn("Got OS:PSA for unknown peer.")}},gotContentFromNetwork:{type:"OS:C",callback:function(e,o,n){t.gotContentFromNetwork(e,o,n)}},version_vector_propagation:{type:"OS:VVP",callback:function(e,o,n){t.gotVVFromNetwork(e,o,n)}}},this.serverQueue=new ALQueue,this.serverTimer=setInterval(function(){t.clearServerQueue()},this.legion.options.objectOptions.serverInterval),this.peersQueue=new ALQueue,this.peersTimer=setInterval(function(){t.clearPeersQueue()},this.legion.options.objectOptions.peerInterval);var o=this.legion.overlay.getPeers();o.length>0&&console.warn("Already have peers!",o.length);for(var n=0;n<o.length;n++){var r=new PeerSync(this.legion,this,o[n]);this.peerSyncs.set(o[n].remoteID,r),r.sync()}this.legion.messagingAPI.setHandlerFor(this.handlers.peerSync.type,this.handlers.peerSync.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.peerSyncAnswer.type,this.handlers.peerSyncAnswer.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.gotContentFromNetwork.type,this.handlers.gotContentFromNetwork.callback),this.legion.messagingAPI.setHandlerFor(this.handlers.version_vector_propagation.type,this.handlers.version_vector_propagation.callback),this.legion.bullyProtocol.setOnBullyCallback(function(e){t.checkIfMustHaveServer()})}function Duplicates(){this.senders=[]}function RangeSet(){this.pairs=[]}function Overlay(e){this.legion=e,this.peers=new ALMap,this.overlayProtocol=new this.legion.options.overlayProtocol(this,this.legion)}function CRDT(e,t,o){this.objectStore=o,this.objectID=e,this.crdt=t,this.state={},this.getValue=t.crdt.getValue,this.merge=t.crdt.merge,this.compare=t.crdt.compare,this.fromJSONString=t.crdt.fromJSONString,this.toJSONString=t.crdt.toJSONString,this.garbageCollect=t.crdt.garbageCollect,this.getDelta=t.crdt.getDelta,this.applyDelta=t.crdt.applyDelta,this.gcvv={};for(var n=Object.keys(this.crdt.crdt.base_value.state),r=0;r<n.length;r++)"function"==typeof this.crdt.crdt.base_value.state[n[r]]?this.state[n[r]]=new this.crdt.crdt.base_value.state[n[r]]:this.state[n[r]]=JSON.parse(JSON.stringify(this.crdt.crdt.base_value.state[n[r]]));this.locals=[],this.remotes=[],this.localOP=0,this.opHistory=new ALMap,this.versionVector=new ALMap;var s=Object.keys(this.crdt.crdt.operations),i=this;if(this.crdt.propagation==CRDT.OP_BASED)for(var r=0;r<s.length;r++)!function(e){i.locals[e]=i.crdt.crdt.operations[e].local,i.remotes[e]=i.crdt.crdt.operations[e].remote,i[e]=function(){var t=i.locals[e].apply(i,arguments),o=i.getVersionVector();if(!t)return i.remotes[e].apply(i,arguments);if("undefined"==typeof CRDT_Database){var n=i.remotes[e].apply(i,[t]);return i.addOpToHistory(i.objectStore.legion.id,++i.localOP,t,e,o),i.addOpToCurrentVersionVector(i.objectStore.legion.id,i.localOP),i.objectStore.propagate(i.objectID,i.objectStore.legion.id,i.localOP,{all:!0},i.crdt.type),i.callback&&i.callback(n,{local:!0}),n}var n=i.remotes[e].apply(i,[t]);i.addOpToHistory("ObjectServer",++i.localOP,t,e,o),i.addOpToCurrentVersionVector("ObjectServer",i.localOP),i.objectStore.propagate(i.objectID,"ObjectServer",i.localOP,{all:!0},i.crdt.type),i.callback&&i.callback(n,{local:!0})}}(s[r]);else if(this.crdt.propagation==CRDT.STATE_BASED)for(var r=0;r<s.length;r++)!function(e){i[e]=function(){var t=i.crdt.crdt.operations[e].apply(i,arguments);i.objectStore.propagateState(i.objectID,{all:!0}),i.callback&&i.callback(t,{local:!0})}}(s[r]);else if(this.crdt.propagation==CRDT.DELTA_BASED)for(var r=0;r<s.length;r++)!function(e){i[e]=function(){for(var t={id:i.objectStore.legion.id,o:++i.localOP},o=[],n=0;n<arguments.length;n++)o.push(arguments[n]);o.push(t);var r=i.crdt.crdt.operations[e].apply(i,o);i.addOpToCurrentVersionVector(t.id,t.o),i.objectStore.propagateDelta(i.objectID,{all:!0}),i.callback&&i.callback(r,{local:!0})}}(s[r]);else console.error("No def for propagation type",this.crdt.propagation),console.error(JSON.stringify(this.crdt),e);this.callback=null}function PeerConnection(e,t){detailedDebug&&console.log("PC from "+t.id+" to "+e),this.remoteID=e,this.legion=t,this.peer=new RTCPeerConnection(servers,pcConstraint),this.channel=null;var o=this;this.init_timeout=setTimeout(function(){o.onInitTimeout()},DEFAULT_PEER_INIT_TIMEOUT),this.unique=null,this.lastKeepAlive=Date.now(),this.keepAliveInterval=setInterval(function(){o.keepAlive()},KEEP_ALIVE_INTERVAL)}function PeerSync(e,t,o){console.log("New peerSync from "+e.id+" to "+o.remoteID),this.legion=e,this.objectStore=t,this.peerConnection=o,this.isSynced=!1,this.queueAfterSync=new ALQueue,this.sharedObjects=new ALMap;var n=this;this.psTimeout=setTimeout(function(){console.error("No PeerSync in time.",n.legion.id,n.peerConnection.remoteID)},5e3)}function ServerConnection(e,t){this.legion=t,this.server=e,this.remoteID=this.server.ip+":"+this.server.port,this.socket=new WebSocket("ws://"+this.server.ip+":"+this.server.port);var o=this;this.socket.onopen=function(){o.legion.connectionManager.onOpenServer(o)},this.socket.onmessage=function(e){var t=JSON.parse(e.data);console.log("Got "+t.type+" from "+o.remoteID+" s: "+t.sender);var n=JSON.parse(e.data);t.content?decompress(t.content,function(e){t.content=JSON.parse(e),o.legion.messagingAPI.onMessage(o,t,n)}):decompress("5d00000100040000000000000000331849b7e4c02e1ffffac8a000",function(e){o.legion.messagingAPI.onMessage(o,t,n)})},this.socket.onclose=function(){o.legion.connectionManager.onCloseServer(o)},this.socket.onerror=function(e){console.error("ServerSocket Error",e)}}function B2BOverlay(e,t){this.overlay=e,this.legion=t,this.meta_interval=45e3,this.initial_ttl=3,this.initial_n=5,this.min=7,this.max=10,this.conn_check_timeout=8e3,this.conn_check_timeout_startup=4e3,this.conn_check_timeout_multiplier=1.5,this.RAND_VAL=.3;var o=this;this.legion.messagingAPI.setHandlerFor("P2PMeta",function(e,t,n){o.gotP2PMeta(e,t,n)}),this.legion.messagingAPI.setHandlerFor("JoinRequest",function(e,t,n){o.onJoinRequest(e,t,n)}),this.legion.messagingAPI.setHandlerFor("JoinAnswer",function(e,t,n){o.onJoinAnswer(e,t,n)});var n=function(){o.sendP2PMeta(),o.meta_interval=Math.min(o.meta_interval+2500,45e3),setTimeout(n,o.meta_interval)};setTimeout(n,o.meta_interval);var r=function(){o.checkIfMustHaveServer();var e=!1;o.overlay.peerCount()<o.min&&(o.legion.generateMessage("JoinRequest",null,function(e){e.N=o.max-o.overlay.peerCount(),e.TTL=o.initial_ttl,o.legion.messagingAPI.propagateToN(e,!0)}),e=!0),o.overlay.peerCount()>o.max&&o.removeBestPeer(),e?setTimeout(r,o.conn_check_timeout):setTimeout(r,Math.min(30,o.conn_check_timeout*o.conn_check_timeout_multiplier))};this.legion.bullyProtocol.setOnBullyCallback(function(e){o.checkIfMustHaveServer()}),setTimeout(r,o.conn_check_timeout_startup)}function SimpleBully(e){this.legion=e;var t=this;this.handlers={bully:{type:"Bully",callback:function(e,o){var n=e.sender.toString(),r=Date.now();n<=t.bully?(t.bully=n,t.lastBullyMessage=r,t.bullied(),"undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",n)):("undefined"!=typeof bullyLog&&bullyLog&&console.log("Be bullied by",n,"but mine is",t.bully),t.onClientConnection(o))}}},this.bully=this.legion.id.toString(),this.lastBullyMessage=Date.now(),this.bullyMustHaveInterval=this.legion.options.bullyProtocol.options.bullyMustHaveInterval,this.bullySendInterval=this.legion.options.bullyProtocol.options.bullySendInterval,this.bullyStartTime=this.legion.options.bullyProtocol.options.bullyStartTime,setTimeout(function(){t.interval=setInterval(function(){t.floodBully()},t.bullySendInterval)},t.bullyStartTime),this.legion.messagingAPI.setHandlerFor(this.handlers.bully.type,this.handlers.bully.callback),this.callbacks=[]}function FloodMessaging(e,t){this.messagingAPI=e,this.legion=t}function SimpleOverlay(e,t){this.overlay=e,this.legion=t;var o=this;this.interval=setInterval(function(){o.floodJoin()},15e3),this.started=!1,setTimeout(function(){o.floodJoin()},2e3),this.legion.messagingAPI.setHandlerFor("ConnectToAnyNodesPlease",function(e,t,n){o.handleJoin(e,t,n)})}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t,e.play()},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(debug&&console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,t){"undefined"!=typeof e.srcObject?e.srcObject=t:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=t:"undefined"!=typeof e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){e.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):(RTCPeerConnection=null,console.log("Browser does not appear to be WebRTC-capable")),"undefined"!=typeof exports&&(exports.ALList=ALList),ALList.prototype.size=function(){return this.list.length},ALList.prototype.asArray=function(){return this.list},ALList.prototype.put=function(e,t){return 0>e||e>=this.list.length?null:void(this.list=this.list.slice(0,e).concat([t]).concat(this.list.slice(e,this.size())))},ALList.prototype.remove=function(e){var t=this.list[e];return t?(this.list=this.list.slice(0,e).concat(this.list.slice(e+1,this.size())),t):void 0},ALList.prototype.get=function(e){return 0>e||e>=this.list.length?null:this.list[e]},ALList.prototype.toJSONString=function(){return this.list},ALList.prototype.fromJSONString=function(e){e?this.list=e:this.list=[]},ConnectionManager.prototype.startSignallingConnection=function(){this.serverConnection||new this.legion.options.signallingConnection.type(this.legion.options.signallingConnection.server,this.legion)},ConnectionManager.prototype.hasPeer=function(e){return this.peerConnections.contains(e)},ConnectionManager.prototype.connectPeer=function(e){return this.hasPeer(e)?!1:(this.peerConnections.set(e,new PeerConnection(e,this.legion)),this.peerConnections.get(e).startLocal(),!0)},ConnectionManager.prototype.connectPeerRemote=function(e){var t=e.sender,o=e.content,n=this.peerConnections.get(t);n?t<this.legion.id&&(this.peerConnections.get(t).cancelAll(),this.peerConnections.set(t,new PeerConnection(t,this.legion)),this.peerConnections.get(t).startRemote(o,e.unique)):(this.peerConnections.set(t,new PeerConnection(t,this.legion)),this.peerConnections.get(t).startRemote(o,e.unique))},ConnectionManager.prototype.handleSignalling=function(e,t){if(e.destination!=this.legion.id)this.legion.messagingAPI.broadcastMessage(t);else if("OfferAsAnswer"==e.type)this.connectPeerRemote(e);else{var o=e.unique;if(this.peerConnections.contains(e.sender)){var n=this.peerConnections.get(e.sender);if(n.unique!=o)console.warn("Got as unique",o,"when expecting",n.unique);else switch(e.type){case"OfferReturn":return void n.returnOffer(e.content);case"ICE":return void n.return_ice(e.content)}}else console.warn("Got",e.type,"for no peer",e.sender,this.legion.id)}},ConnectionManager.prototype.onCloseServer=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID+" of type "+e.constructor.name),this.serverConnection=null,e instanceof this.legion.options.signallingConnection.type&&(this.serverConnection=null,this.legion.overlay.onServerDisconnect(e)),e instanceof this.legion.options.objectServerConnection.type&&(this.legion.objectStore?this.legion.objectStore.onServerDisconnect(e):console.error("Should not disconnect form objects server when not having an objects store!")),this.legion.bullyProtocol&&this.legion.bullyProtocol.onServerDisconnect(e)},ConnectionManager.prototype.onOpenServer=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID+" of type "+e.constructor.name),e instanceof this.legion.options.signallingConnection.type&&(this.serverConnection=e,this.legion.overlay.onServerConnection(e)),e instanceof this.legion.options.objectServerConnection.type&&(this.legion.objectStore?this.legion.objectStore.onServerConnection(e):console.error("Should not connect to objects server when not having an objects store!")),this.legion.bullyProtocol&&this.legion.bullyProtocol.onServerConnection(e)},ConnectionManager.prototype.onOpenClient=function(e){console.log(this.legion.getTime()+" Overlay OPEN "+this.legion.id+" to "+e.remoteID),this.legion.overlay.addPeer(e),this.legion.objectStore&&this.legion.objectStore.onClientConnection(e),this.legion.bullyProtocol&&this.legion.bullyProtocol.onClientConnection(e)},ConnectionManager.prototype.onCloseClient=function(e){console.log(this.legion.getTime()+" Overlay CLOSE "+this.legion.id+" to "+e.remoteID),this.peerConnections["delete"](e.remoteID),this.legion.overlay.removePeer(e),this.legion.objectStore&&this.legion.objectStore.onClientDisconnect(e),this.legion.bullyProtocol&&this.legion.bullyProtocol.onClientDisconnect(e)},ConnectionManager.prototype.sendStartOffer=function(e,t,o){var n=this;this.legion.generateMessage("OfferAsAnswer",e,function(e){e.destination=o.remoteID,e.unique=t,n.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendReturnOffer=function(e,t,o){var n=this;this.legion.generateMessage("OfferReturn",e,function(e){e.destination=o.remoteID,e.unique=t,n.legion.messagingAPI.broadcastMessage(e)})},ConnectionManager.prototype.sendICE=function(e,t,o){var n=this;this.legion.generateMessage("ICE",e,function(e){e.destination=o.remoteID,e.unique=t,n.legion.messagingAPI.broadcastMessage(e)})},"undefined"!=typeof exports&&(exports.ALMap=ALMap),ALMap.prototype.set=function(e,t){"object"==typeof e&&(e=JSON.stringify(e)),this.map[e]=t},ALMap.prototype.setAll=function(e,t){if(t instanceof Array)for(var o=0;o<e.length;o++)"object"==typeof e[o]?this.set(JSON.stringify(e[o]),t[o]):this.set(e[o],t[o]);else for(var o=0;o<e.length;o++)"object"==typeof e[o]?this.set(JSON.stringify(e[o]),t):this.set(e[o],t)},ALMap.prototype.deleteAll=function(e){for(var t=0;t<e.length;t++)this["delete"](e[t])},ALMap.prototype["delete"]=function(e){this.map[e]=null,delete this.map[e]},ALMap.prototype.get=function(e){return"object"==typeof e?this.map[JSON.stringify(e)]:this.map[e]},ALMap.prototype.contains=function(e){return"object"==typeof e?"undefined"!=typeof this.map[JSON.stringify(e)]:"undefined"!=typeof this.map[e]},ALMap.prototype.keys=function(){return Object.keys(this.map)},ALMap.prototype.values=function(){for(var e=[],t=this.keys(),o=0;o<t.length;o++)e.push(this.get(t[o]));return e},ALMap.prototype.size=function(){return this.keys().length},ALMap.prototype.clear=function(){return this.map=[]},Legion.prototype.join=function(){this.connectionManager.startSignallingConnection()},Legion.prototype.getMessageAPI=function(){return this.messagingAPI},Legion.prototype.getObjectStore=function(){return this.objectStore||(this.objectStore=new ObjectStore(this)),this.objectStore},Legion.prototype.generateMessage=function(e,t,o){function n(e){var t=0;return function(o,n){return 0!==t&&"object"==typeof e&&"object"==typeof n&&e==n?"[Circular]":t>=29?"[Unknown]":(++t,n)}}if(!e)return void console.error("No type for message.");var r={type:e,sender:this.id,ID:++this.messageCount};if(t){var s;try{s=JSON.stringify(t)}catch(i){return console.error(i),console.error(t),console.log("Censoring: ",t),void console.log("Result: ",JSON.stringify(t,n(t)))}compress(s,function(e){r.content=e,o(r)},function(e){console.error("Compress failed!",e),o(null)})}else o(r)},Legion.prototype.reGenerateMessage=function(e,t,o){t?compress(JSON.stringify(t),function(t){e.content=t,o(e)},function(e){console.error("Compress failed!",e),o(null)}):(e.content&&delete e.content,o(e))},Legion.prototype.getTime=function(){return Date.now()},Legion.prototype.randInt=function(){return Math.floor(Math.random()*Number.MAX_VALUE%Math.pow(10,10))},"undefined"!=typeof exports&&(exports.ALQueue=ALQueue),ALQueue.prototype.size=function(){return this.queue.length},ALQueue.prototype.push=function(e){this.queue.push(e)},ALQueue.prototype.pop=function(){var e=this.queue[0];return this.queue=this.queue.slice(1),e},ALQueue.prototype.clear=function(){this.queue=[]},MessagingAPI.prototype.onMessage=function(e,t,o){return t.sender==this.legion.id?void console.warn("Return to creator fault",t,e.remoteID):this.duplicates.contains(t.sender,t.ID)?void console.log("Duplicate: ("+t.sender+","+t.ID+")"):(this.duplicates.add(t.sender,t.ID),debug&&console.log(t.type+" from "+e.remoteID+" by "+t.sender+" to "+t.destination),detailedDebug&&console.log(t),void(!t.destination||t.destination&&t.destination==this.legion.id?this.deliver(t,o,e):this.messagingProtocol.onMessage(e,t,o)))},MessagingAPI.prototype.deliver=function(e,t,o){this.callbacks.contains(e.type)?this.callbacks.get(e.type)(e,t,o):console.error("can't deliver: no handler defined",JSON.stringify(e))},MessagingAPI.prototype.broadcastMessage=function(e,t){this.messagingProtocol.broadcastMessage(e,t)},MessagingAPI.prototype.sendTo=function(e,t){t.destination&&console.warn("Notice: message had a pre-defined destination!"),this.messagingProtocol.sendTo(e,t)},MessagingAPI.prototype.propagateToN=function(e,t){if(!e.N)return void console.error("NO N!");var o=this.legion.overlay.getPeers(e.N),n=0;o.length==e.N?e.N=1:n=e.N-o.length;for(var r=0;r<o.length;r++)if(0!=r||this.legion.bullyProtocol.amBullied())o[r].remoteID!=e.sender&&o[r].send(e);else{var s=JSON.parse(JSON.stringify(e));s.N=1+n,o[r].remoteID!=e.sender&&o[r].send(s)}if(!this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.isAlive()){var i=JSON.parse(JSON.stringify(e));i.N=1+n,this.legion.connectionManager.serverConnection.send(i)}},MessagingAPI.prototype.broadcast=function(e,t){var o=this;this.legion.generateMessage(e,t,function(e){o.broadcastMessage(e)})},MessagingAPI.prototype.setHandlerFor=function(e,t){this.callbacks.set(e,t)},"undefined"!=typeof exports&&(exports.ALSet=ALSet),ALSet.prototype.add=function(e){this.set[e]=!0},ALSet.prototype["delete"]=function(e){delete this.set[e]},ALSet.prototype.contains=function(e){return this.set[e]===!0},ALSet.prototype.size=function(){return Object.keys(this.set).length},ALSet.prototype.asArray=function(){return Object.keys(this.set)},ALSet.prototype.toJSONString=function(){return this.asArray()},ALSet.prototype.fromJSONString=function(e){if(this.set={},e)for(var t=0;t<e.length;t++)this.set[e[t]]=!0},ObjectServerConnection.prototype.close=function(){this.socket.close()},ObjectServerConnection.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.socket.readyState==WebSocket.OPEN&&(console.log("Sent "+JSON.parse(e).type+" to "+this.remoteID+" s: "+JSON.parse(e).sender),this.socket.send(e))},"undefined"!=typeof exports&&(exports.compress=compress,exports.decompress=decompress,LZMA=require("./../../node_modules/lzma"));var fromDecToHex=function(e){if(0>e)return e=4294967295+e+1,e.toString(16).substring(6,8);var t=e.toString(16);return 1==t.length&&(t="0"+t),t},fromHexToDec=function(e){return parseInt(e,16)},CRDT_LIB={};ObjectStore.prototype.checkIfMustHaveServer=function(){this.legion.bullyProtocol.amBullied()&&this.disconnectFromObjectServer()},ObjectStore.prototype.gotVVFromNetwork=function(e,t){var o=e.content.objectID,n=e.content.vv,r=this.crdts.get(o);if(!r)return void console.warn("Not implemented: vv for CRDT I do not have.");var s=CRDT.versionVectorDiff(r.getVersionVector(),n),i=this;if(Object.keys(s.vv2.missing).length>0){objectsDebug&&console.log("Peer is missing ops.");var a=r.getOperations(s.vv2.missing),c={type:"OPLIST",objectID:o,operations:a};this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,c,function(t){if(t.destination=e.sender,i.objectServer&&t.destination==i.objectServer.peerConnection.remoteID)i.objectServer.send(t);else if(i.peerSyncs.contains(e.sender)){var o=i.peerSyncs.get(e.sender);o.send(t)}else i.legion.messagingAPI.sendTo(e.sender,t)})}Object.keys(s.vv1.missing).length>0&&(objectsDebug&&console.log("I am missing ops."),this.sendVVToNode(o,e.sender)),console.log("gotVVFromNetwork end")},ObjectStore.prototype.sendVVToAll=function(e,t){var o=this.crdts.get(e),n={objectID:e,vv:o.getVersionVector()},r=this;this.legion.generateMessage(this.handlers.version_vector_propagation.type,n,function(e){r.legion.messagingAPI.broadcastMessage(e,[t,r.legion.connectionManager.serverConnection],!0)})},ObjectStore.prototype.sendVVToNode=function(e,t){var o=this.crdts.get(e),n={objectID:e,vv:o.getVersionVector()},r=this;this.legion.generateMessage(this.handlers.version_vector_propagation.type,n,function(e){if(e.destination=t,r.peerSyncs.contains(t)&&(r.peerSyncs.get(t).peerConnection.socket&&1==r.peerSyncs.get(t).peerConnection.socket.readyState||r.peerSyncs.get(t).peerConnection.channel&&"open"==r.peerSyncs.get(t).peerConnection.channel.readyState)){var o=r.peerSyncs.get(t);o.send(e)}else r.objectServer&&r.objectServer.peerConnection.remoteID==t?r.objectServer.send(e):r.legion.messagingAPI.sendTo(t,e)})},ObjectStore.prototype.onMessageFromServer=function(e,t,o){switch(e.type){case this.handlers.peerSync.type:return void this.objectServer.handleSync(e,t,o);case this.handlers.peerSyncAnswer.type:return void this.objectServer.handleSyncAnswer(e,t,o);case this.handlers.gotContentFromNetwork.type:return void this.handlers.gotContentFromNetwork.callback(e,t,o);case this.handlers.version_vector_propagation.type:return void this.handlers.version_vector_propagation.callback(e,t,o)}console.error("No typedef for: "+e)},ObjectStore.prototype.gotContentFromNetwork=function(e,t,o){switch(t.options||(t.options={}),t.options.except=o,console.log(Date.now()+" Got "+e.content.type+" "+JSON.stringify(e).length),JSON.stringify(e).length>1e3&&console.info(e),e.content.type){case"OP":var n=e.content.objectID,r=this.crdts.get(n);r?r.operationsFromNetwork([e.content.msg],o,t):console.error("Got op for no crdt",e);break;case"OPLIST":var s=e.content.operations;s||(s=e.content.ops);var r=this.crdts.get(e.content.objectID);r.operationsFromNetwork(s,o,t);break;case"STATE":var n=e.content.objectID,r=this.crdts.get(n);r?r.stateFromNetwork(r.fromJSONString(e.content.msg.state),o,t):console.error("Got state for no crdt",e);break;case"DELTA":var n=e.content.objectID,r=this.crdts.get(n);r?r.deltaFromNetwork(e.content.msg,o,t):console.error("Got delta for no crdt",e);break;case"DELTAOPS":var n=e.content.objectID,r=this.crdts.get(n);r?r.deltaOPSFromNetwork(e.content,o,t):console.error("Got deltaOps for no crdt",e)}},ObjectStore.prototype.propagateMessage=function(e,t){e.extra=t,this.serverQueue.push(e),this.peersQueue.push(e)},ObjectStore.prototype.disconnectFromObjectServer=function(){this.objectServer&&this.objectServer.close()},ObjectStore.prototype.connectToObjectServer=function(){!this.objectServer&&this.legion.options.objectServerConnection&&new this.legion.options.objectServerConnection.type(this.legion.options.objectServerConnection.server,this,this.legion)},ObjectStore.prototype.useServerMessage=function(e,t){var o=this,n=t.options;if(n.onlyTo&&"string"!=typeof n.onlyTo&&(n.onlyTo=n.onlyTo.remoteID),n.except&&"string"!=typeof n.except&&(n.except=n.except.remoteID),!(n.except&&n.except==this.objectServer.peerConnection||n.except&&n.except==this.objectServer.peerConnection.remoteID))if(t.sender){if(t.extra){switch(t.extra.type){case"STATE":if(e.contains(""+t.objectID))return;e.set(""+t.objectID,!0)}delete t.extra}this.legion.generateMessage("Fake",{fake:"data"},function(e){o.objectServer.send(t)})}else{var r={};switch(t.type){case"OP":var s=t.objectID,i=""+s;if(e.contains(i))return;return e.set(i,!0),void this.sendVVToNode(s,this.objectServer.peerConnection.remoteID);var s,a,i;case"OPLIST":break;case"STATE":var s=t.objectID,i=""+s;if(e.contains(i))return;e.set(i,!0);var a=this.crdts.get(s),c=a.toJSONString(a.getState());r={objectID:s,state:c};break;case"DELTA":var s=t.objectID,i=""+s;if(e.contains(i))return;e.set(i,!0);var a=this.crdts.get(s),l=a.getVersionVector(),p=a.getGCVV();r={objectID:s,vv:l,gcvv:p}}t.msg=r,this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,t,function(e){o.objectServer.send(e)})}},ObjectStore.prototype.clearServerQueue=function(){if(this.legion.bullyProtocol.amBullied())return this.serverQueue.size()>0&&(console.log("Clearing server queue. Am bullied."),this.serverQueue.clear()),void this.disconnectFromObjectServer();if(!this.objectServer)return console.log("Don't have a connection to objects server. Will try again soon."),void this.connectToObjectServer();if(this.serverQueue.size()>0){console.log("Messages in server queue: "+this.serverQueue.size());for(var e=this.serverQueue.pop(),t=new ALMap;e;)this.useServerMessage(t,e),e=this.serverQueue.pop()}},ObjectStore.prototype.usePeersMessage=function(e,t){var o=this,n=t.options;const r=n.except;if(n.onlyTo&&"string"!=typeof n.onlyTo&&(n.onlyTo=n.onlyTo.remoteID),n.except&&"string"!=typeof n.except&&(n.except=n.except.remoteID),t.sender){if(t.extra){switch(t.extra.type){case"STATE":if(e.contains(""+t.objectID))return;e.set(""+t.objectID,!0)}delete t.extra}this.legion.generateMessage("Fake",{fake:"data"},function(e){o.legion.messagingAPI.broadcastMessage(t,[o.legion.connectionManager.serverConnection],!0)})}else{var s={};switch(t.type){case"OP":var i=t.objectID,a=""+i;if(e.contains(a))return;return e.set(a,!0),void this.sendVVToAll(i,n.except);var a,c;case"OPLIST":break;case"STATE":var i=t.objectID,a=""+i;if(e.contains(a))return;e.set(a,!0);var c=this.crdts.get(i),l=c.toJSONString(c.getState());s={objectID:i,state:l};break;case"DELTA":var i=t.objectID,a=""+i;if(e.contains(a))return;e.set(a,!0);var c=this.crdts.get(i),p=c.getVersionVector(),h=c.getGCVV();s={objectID:i,vv:p,gcvv:h}}t.msg=s,this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,t,function(e){const t=n.onlyTo;if(t)if(e.destination=t,o.peerSyncs.contains(t)){if(o.objectServer&&t==o.objectServer.remoteID)return;e.destination=t;var s=o.peerSyncs.get(t);s.send(e),console.log("Sent",e.type,"to",t)}else o.legion.messagingAPI.sendTo(t,e);else r?o.legion.messagingAPI.broadcastMessage(e,[r,o.legion.connectionManager.serverConnection],!0):o.legion.messagingAPI.broadcastMessage(e,[o.legion.connectionManager.serverConnection],!0)})}},ObjectStore.prototype.clearPeersQueue=function(){if(this.peersQueue.size()>0){console.log("Messages in peers queue: "+this.peersQueue.size());for(var e=this.peersQueue.pop(),t=new ALMap;e;)this.usePeersMessage(t,e),e=this.peersQueue.pop()}},ObjectStore.prototype.defineCRDT=function(e){this.types.contains(e.type)?console.error("Can't redefine existing CRDT.",e):this.types.set(e.type,e)},ObjectStore.prototype.get=function(e,t,o){if(this.types.contains(t)){if(this.crdts.contains(e))return this.crdts.get(e);var n=this.types.get(t),r=new CRDT(e,n,this);return this.crdts.set(e,r),this.legion.bullyProtocol.amBullied()&&!o?(console.info("Send vv to "+this.legion.bullyProtocol.bully),this.sendVVToNode(e,this.legion.bullyProtocol.bully)):this.objectServer&&!o&&(console.info("Send vv to "+this.objectServer.peerConnection.remoteID),this.sendVVToNode(e,this.objectServer.peerConnection.remoteID)),r}console.error("No typedef found for CRDT.",t)},ObjectStore.prototype.propagate=function(e,t,o,n,r){var s={type:"OP",clientID:t,objectID:e,operationID:o,options:n,objectType:r};this.serverQueue.push(s),this.peersQueue.push(s)},ObjectStore.prototype.propagateAll=function(e,t,o){var n={type:"OPLIST",ops:t,objectID:e,options:o};this.serverQueue.push(n),this.peersQueue.push(n)},ObjectStore.prototype.onServerDisconnect=function(e){this.objectServer=null,this.serverQueue.clear()},ObjectStore.prototype.onServerConnection=function(e){this.objectServer=new PeerSync(this.legion,this,e),this.objectServer.sync()},ObjectStore.prototype.onClientConnection=function(e){var t=new PeerSync(this.legion,this,e);this.peerSyncs.set(e.remoteID,t),t.sync()},ObjectStore.prototype.onClientDisconnect=function(e){var t=this.peerSyncs.get(e.remoteID);t&&(this.peerSyncs["delete"](e.remoteID),t.finalize())},ObjectStore.prototype.propagateState=function(e,t){var o={type:"STATE",objectID:e,options:t};this.serverQueue.push(o),this.peersQueue.push(o)},ObjectStore.prototype.getCRDT=function(e){return this.crdts.get(e)},ObjectStore.prototype.propagateDelta=function(e,t){var o={type:"DELTA",objectID:e,options:t};this.serverQueue.push(o),this.peersQueue.push(o)},ObjectStore.prototype.sendDeltaOPSTo=function(e,t,o){
var n={delta_ops:t,objectID:o.objectID,type:"DELTAOPS",vv:o.getVersionVector(),gcvv:o.getGCVV()},r=this;this.legion.generateMessage(this.handlers.gotContentFromNetwork.type,n,function(t){if(r.objectServer&&e.remoteID==r.objectServer.remoteID)r.objectServer.send(t);else{var o=r.peerSyncs.get(e.remoteID);o.send(t)}})},"undefined"!=typeof exports&&(exports.Duplicates=Duplicates),Duplicates.prototype.add=function(e,t){this.senders[e]||(this.senders[e]=new RangeSet),this.senders[e].add(t)},Duplicates.prototype.contains=function(e,t){return this.senders[e]?this.senders[e].contains(t):!1},Duplicates.prototype.print=function(){for(var e=Object.keys(this.senders),t=0;t<e.length;t++)console.log(e[t]),this.senders[e[t]].print()},RangeSet.prototype.add=function(e){for(var t=this.pairs.length-1;t>=0;t--){if(e>=this.pairs[t].first&&e<=this.pairs[t].last)return;if(e==this.pairs[t].last+1){for(this.pairs[t].last+=1;this.pairs[t-1]&&this.pairs[t].last==this.pairs[t-1].first-1;)this.pairs[t].last=this.pairs[t-1].last,this.pairs.splice(t-1,1),t--;return}if(e==this.pairs[t].first-1)return void(this.pairs[t].first-=1);if(e<this.pairs[t].first)return void this.pairs.splice(t+1,0,{first:e,last:e})}this.pairs.splice(0,0,{first:e,last:e})},RangeSet.prototype.contains=function(e){for(var t=0;t<this.pairs.length;t++)if(e>=this.pairs[t].first&&e<=this.pairs[t].last)return!0;return!1},RangeSet.prototype.print=function(){for(var e=0;e<this.pairs.length;e++)console.log(this.pairs[e].first+" : "+this.pairs[e].last)},Overlay.prototype.peerCount=function(){return this.peers.size()},Overlay.prototype.addPeer=function(e){this.peers.set(e.remoteID,e),this.overlayProtocol.onClientConnection(e)},Overlay.prototype.removePeer=function(e){this.peers["delete"](e.remoteID),this.overlayProtocol.onClientDisconnect(e)},Overlay.prototype.onServerDisconnect=function(e){this.overlayProtocol.onServerDisconnect(e)},Overlay.prototype.onServerConnection=function(e){this.overlayProtocol.onServerConnection(e)},Overlay.prototype.getPeers=function(e){if(e||(e=this.peerCount()),e=parseInt(e),e==this.peerCount)return this.peers.values();var t=this.shuffle(this.peers.values());return t.slice(0,e)},Overlay.prototype.shuffle=function(e){var t,o,n=e.length;if(n)for(;--n;)o=Math.floor(Math.random()*(n+1)),t=e[o],e[o]=e[n],e[n]=t;return e},"undefined"!=typeof exports&&(CRDT_Database=!0,exports.CRDT=CRDT);var crtd_type={type:"crdtType",propagation:1,crdt:{base_value:function(){},getValue:function(){},operations:{},merge:function(e,t){},compare:function(e,t){},fromJSONString:function(e){},toJSONString:function(e){},garbageCollect:function(e){},getDelta:function(e){},applyDelta:function(e,t,o){}}};CRDT.STATE_BASED=1,CRDT.OP_BASED=2,CRDT.DELTA_BASED=3,CRDT.STATE=Object.freeze({COMPARE_RESPONSE:{EQUALS:1,LOWER:2,HIGHER:3,MUST_MERGE:4}}),CRDT.prototype.addOpToCurrentVersionVector=function(e,t){this.versionVector.set(e,t)},CRDT.prototype.addOpToHistory=function(e,t,o,n,r){var s=this.opHistory.get(e);s||(s=new ALMap,this.opHistory.set(e,s)),s.set(t,{dependencyVV:r,opID:t,result:o,opName:n})},CRDT.prototype.getOpFromHistory=function(e,t){var o=this.opHistory.get(e);if(o)return o.get(t)},CRDT.prototype.getState=function(){return this.state},CRDT.prototype.setOnStateChange=function(e){this.callback=e},CRDT.prototype.getOperations=function(e){for(var t=[],o=Object.keys(e),n=0;n<o.length;n++)for(var r=o[n],s=e[r],i=0;i<s.length;i++){var a=s[i],c=this.getOpFromHistory(r,a);c.clientID=r,t.push(c)}return t},CRDT.prototype.getVersionVector=function(){for(var e=this.versionVector.keys(),t={},o=0;o<e.length;o++)t[e[o]]=this.versionVector.get(e[o]);return t},CRDT.prototype.getGCVV=function(){return this.gcvv},CRDT.prototype.stateFromNetwork=function(e,t,o){var n=this.compare(this.getState(),e);switch(console.log("From network: "+n),n){case CRDT.STATE.COMPARE_RESPONSE.EQUALS:break;case CRDT.STATE.COMPARE_RESPONSE.LOWER:this.objectStore.propagateState(this.objectID,{onlyTo:t});break;case CRDT.STATE.COMPARE_RESPONSE.HIGHER:var r=this.merge(this.getState(),e);this.state=r.mergeResult,this.callback&&this.callback(r.stateChange,{local:!1}),o?(o.options={except:t.remoteID},this.objectStore.propagateMessage(o,{type:"STATE",objectID:this.objectID})):this.objectStore.propagateState(this.objectID,{except:t});break;case CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:var r=this.merge(this.getState(),e);this.state=r.mergeResult,this.callback&&this.callback(r.stateChange,{local:!1}),this.objectStore.propagateState(this.objectID,{all:!0})}},CRDT.prototype.deltaFromNetwork=function(e,t,o){objectsDebug&&console.error("deltaFromNetwork");var n=e.vv,r=Object.keys(n),s=this.getDelta(n,e.gcvv);s.has&&(objectsDebug&&console.info(s),this.objectStore.sendDeltaOPSTo(t,s,this));for(var i=0;i<r.length;i++){if(!this.versionVector.contains(r[i])){objectsDebug&&console.info("pd"),this.objectStore.propagateDelta(this.objectID,{all:!0});break}if(this.versionVector.get(r[i])<n[r[i]]){objectsDebug&&console.info("pd"),this.objectStore.propagateDelta(this.objectID,{all:!0});break}}},CRDT.prototype.deltaOPSFromNetwork=function(e,t,o){objectsDebug&&console.error("deltaOPSFromNetwork"),objectsDebug&&console.error(e),objectsDebug&&console.error(t),objectsDebug&&console.error(o),this.applyDelta(e.delta_ops,e.vv,e.gcvv),this.garbageCollect(e.gcvv);for(var n=Object.keys(e.vv),r=0;r<n.length;r++){var s=n[r];this.versionVector.contains(s)?this.versionVector.set(s,Math.max(e.vv[s],this.versionVector.get(s))):this.versionVector.set(s,e.vv[s])}},CRDT.prototype.operationsFromNetwork=function(e,t,o){for(var n=[],r=[],s=[],i=0,a=e.length;e.length>0;){var c=!1;for(console.log("Operations to go:"+e.length);i<e.length;){var l=e[i];if(this.alreadyHadOp(l))s.push(l),e.splice(i,1),c=!0;else if(this.depsMatchedFor(l)){var p=this.remotes[l.opName].apply(this,[l.result]);this.addOpToHistory(l.clientID,l.opID,l.result,l.opName,l.dependencyVV),this.addOpToCurrentVersionVector(l.clientID,l.opID),n.push(p),r.push(l),e.splice(i,1),c=!0}else i++}if(!c){console.warn(this.getState()),console.warn(this.getVersionVector()),console.warn(e),this.objectStore.sendVVToNode(this.objectID,t.remoteID);break}i=0}s.length>0&&console.warn("Already had:",s),n.length>0&&this.callback&&this.callback(n,{local:!1}),r.length==a?o?(o.options={except:t.remoteID},this.objectStore.propagateMessage(o)):this.objectStore.propagateAll(this.objectID,r,{except:t}):r.length>0&&this.objectStore.propagateAll(this.objectID,r,{except:t})},CRDT.prototype.depsMatchedFor=function(e){for(var t=e.dependencyVV,o=Object.keys(t),n=0;n<o.length;n++)if(!this.alreadyHadOperation(o[n],t[o[n]]))return!1;return!0},CRDT.prototype.alreadyHadOp=function(e){return this.alreadyHadOperation(e.clientID,e.opID)},CRDT.prototype.alreadyHadOperation=function(e,t){return this.versionVector.contains(e)?t<=this.versionVector.get(e):!1},CRDT.prototype.versionVectorDiff=function(e,t){for(var o={vv1:{missing:{}},vv2:{missing:{}}},n=Object.keys(e),r=Object.keys(t),s=0;s<n.length;s++){var i=n[s];if(t[i]){if(t[i]>e[i]){o.vv1.missing[i]=[];for(var a=e[i]+1;a<=t[i];a++)o.vv1.missing[i].push(a)}}else{o.vv2.missing[i]=[];for(var a=1;a<=e[i];a++)o.vv2.missing[i].push(a)}}for(var c=0;c<r.length;c++){var i=r[c];if(e[i]){if(e[i]>t[i]){o.vv2.missing[i]=[];for(var a=t[i]+1;a<=e[i];a++)o.vv2.missing[i].push(a)}}else{o.vv1.missing[i]=[];for(var a=1;a<=t[i];a++)o.vv1.missing[i].push(a)}}return o};var DEFAULT_PEER_INIT_TIMEOUT=15e3,KEEP_ALIVE_INTERVAL=1e4,KEEP_ALIVE_MESSAGE={type:"ka"},KEEP_ALIVE_MUST_HAVE=3e4;PeerConnection.prototype.keepAlive=function(){this.lastKeepAlive+KEEP_ALIVE_MUST_HAVE<Date.now()?(console.warn("Peer "+this.legion.id+" keepAlive timeout from "+this.remoteID+"."),this.isAlive()&&this.channel.close(),clearInterval(this.keepAliveInterval)):this.send(KEEP_ALIVE_MESSAGE)},PeerConnection.prototype.onInitTimeout=function(){console.warn("Peer "+this.legion.id+" connection timeout before getting offer from "+this.remoteID+"."),this.cancelAll(!0)},PeerConnection.prototype.setChannelHandlers=function(){var e=this;this.channel.onmessage=function(t){var o=JSON.parse(t.data);if(o.type==KEEP_ALIVE_MESSAGE.type)return void(e.lastKeepAlive=Date.now());console.log("Got "+o.type+" from "+e.remoteID+" s: "+o.sender);var n=JSON.parse(t.data);if(o.content)try{decompress(o.content,function(t){o.content=JSON.parse(t),e.legion.messagingAPI.onMessage(e,o,n)})}catch(r){console.error(t),console.error(o),console.error(n),console.error(r)}else decompress("5d00000100040000000000000000331849b7e4c02e1ffffac8a000",function(t){e.legion.messagingAPI.onMessage(e,o,n)})},this.channel.onopen=function(t){clearTimeout(e.init_timeout),e.legion.connectionManager.onOpenClient(e)},this.channel.onclose=function(t){e.legion.connectionManager.onCloseClient(e),clearInterval(this.keepAliveInterval)}},PeerConnection.prototype.cancelAll=function(e){var t=this;e||this.channel&&(this.channel.onclose=function(){console.log("Forced a channel close for duplicate PeerConnection.",t.legion.id,t.remoteID)}),this.channel=null,this.peer.close(),clearTimeout(this.init_timeout),clearInterval(this.keepAliveInterval),this.peer=null,this.legion.connectionManager.onCloseClient(this)},PeerConnection.prototype.returnOffer=function(e){detailedDebug&&console.log(e),this.peer.setRemoteDescription(new RTCSessionDescription(e))},PeerConnection.prototype.return_ice=function(e){detailedDebug&&console.log(e);var t=this;this.peer.addIceCandidate(new RTCIceCandidate(e),function(){},function(o){console.warn("onAddIceCandidateError",t.legion.id,t.remoteID,o,e)})},PeerConnection.prototype.onicecandidate=function(e){e.candidate&&this.legion.connectionManager.sendICE(e.candidate,this.unique,this)},PeerConnection.prototype.close=function(){this.cancelAll(!0)},PeerConnection.prototype.startLocal=function(){debug&&console.log("start local: "+this.remoteID);var e=this;this.channel=this.peer.createDataChannel("sendDataChannel",dataConstraint),this.unique=this.legion.randInt(),this.setChannelHandlers(),this.peer.onicecandidate=function(t){e.onicecandidate(t)},this.peer.createOffer(function(t){e.peer.setLocalDescription(t),e.legion.connectionManager.sendStartOffer(t,e.unique,e)},function(t){console.error("onCreateSessionDescriptionError",t),e.onclose()})},PeerConnection.prototype.startRemote=function(e,t){this.unique=t,detailedDebug&&console.log(e),debug&&console.log("start remote: "+this.remoteID),this.peer.setRemoteDescription(new RTCSessionDescription(e));var o=this;this.peer.ondatachannel=function(e){o.channel=e.channel,o.setChannelHandlers()},this.peer.onicecandidate=function(e){o.onicecandidate(e)},this.peer.createAnswer(function(e){o.peer.setLocalDescription(e),o.legion.connectionManager.sendReturnOffer(e,o.unique,o)},function(e){console.error("onCreateSessionDescriptionError",e),o.onclose()})},PeerConnection.prototype.isAlive=function(){return this.channel&&"open"==this.channel.readyState},PeerConnection.prototype.setMeta=function(e){this.meta=e},PeerConnection.prototype.getMeta=function(){return this.meta},PeerConnection.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.channel&&"open"==this.channel.readyState?(this.channel.send(e),console.log("Sent "+JSON.parse(e).type+" to "+this.remoteID+" s: "+JSON.parse(e).sender)):console.warn("Peer has no open channel.")};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraint={optional:[{RtpDataChannels:!1}]},dataConstraint=null;"undefined"!=typeof exports&&(exports.PeerSync=PeerSync,ALMap=require("./ALMap.js"),ALMap=ALMap.ALMap,ALQueue=require("./ALQueue.js"),ALQueue=ALQueue.ALQueue),PeerSync.prototype.close=function(){this.peerConnection.close(),this.finalize()},PeerSync.prototype.send=function(e){"object"==typeof e&&(e=JSON.stringify(e)),this.isSynced&&0==this.queueAfterSync.size()?this.peerConnection.send(e):this.queueAfterSync.push(e)},PeerSync.prototype.finalize=function(){this.isSynced=!1,this.peerConnection=null,this.queueAfterSync.clear(),this.queueAfterSync=null,this.sharedObjects.clear(),this.sharedObjects=null,clearTimeout(this.psTimeout)},PeerSync.prototype.clearQueue=function(){if(this.isSynced){var e=this.queueAfterSync.pop();for(e&&console.log("Clearing queue to: "+this.peerConnection.remoteID+". Size of queue: "+(this.queueAfterSync.size()+1));"undefined"!=typeof e;)this.peerConnection.send(e),e=this.queueAfterSync.pop()}else console.error("Clearing queue before sync.")},PeerSync.prototype.handleSyncAnswer=function(e){for(var t=e.content.states,o=e.content.missing_ops,n=0;n<t.length;n++){var r=this.objectStore.getCRDT(t[n].id,t[n].type);r?r.stateFromNetwork(r.fromJSONString(t[n].state),this.peerConnection):console.log("I should not be here.")}for(var s=0;s<o.length;s++){var i=this.objectStore.getCRDT(o[s].id,o[s].type);i?i.operationsFromNetwork(o[s].operations,this.peerConnection):console.log("I should not be here.")}clearTimeout(this.psTimeout),this.isSynced=!0,this.clearQueue()},PeerSync.prototype.handleSync=function(e){for(var t=e.content.stateObjects,o=e.content.operationObjects,n={missing_ops:[],states:[]},r=0;r<o.length;r++){var s=this.objectStore.getCRDT(o[r].id,o[r].type);if(s){var i=s.getVersionVector(),a=s.versionVectorDiff(i,o[r].vv);Object.keys(a.vv2.missing).length>0&&n.missing_ops.push({id:s.objectID,operations:s.getOperations(a.vv2.missing)})}}for(var c=0;c<t.length;c++){var l=this.objectStore.getCRDT(t[c].id,t[c].type);l&&n.states.push({id:l.objectID,state:l.toJSONString(l.getState())})}var p=this;this.legion.generateMessage(this.objectStore.handlers.peerSyncAnswer.type,n,function(e){e.destination=p.peerConnection.remoteID,p.peerConnection.send(JSON.stringify(e))})},PeerSync.prototype.sync=function(){for(var e=this,t={stateObjects:[],operationObjects:[]},o=this.objectStore.crdts.keys(),n=0;n<o.length;n++){var r=this.objectStore.getCRDT(o[n]);r.crdt.propagation==CRDT.STATE_BASED?t.stateObjects.push({id:r.objectID,type:r.crdt.type}):r.crdt.propagation==CRDT.OP_BASED?t.operationObjects.push({id:r.objectID,vv:r.getVersionVector(),type:r.crdt.type}):r.crdt.propagation==CRDT.DELTA_BASED?console.warn("Not implemented yet."):console.error("Shit happened.")}this.legion.generateMessage(this.objectStore.handlers.peerSync.type,t,function(t){t.destination=e.peerConnection.remoteID,"undefined"!=typeof CRDT_Database&&console.log("Send "+t.type+" to "+e.peerConnection.remoteID+" s: "+t.sender),e.peerConnection.send(JSON.stringify(t))})},ServerConnection.prototype.close=function(){this.socket.close()},ServerConnection.prototype.isAlive=function(){return this.socket&&this.socket.readyState==WebSocket.OPEN},ServerConnection.prototype.send=function(e){e.N,"object"==typeof e&&(e=JSON.stringify(e)),this.socket.readyState==WebSocket.OPEN&&(console.log("Sent "+JSON.parse(e).type+" to "+this.remoteID+" s: "+JSON.parse(e).sender),this.socket.send(e))},"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var TOMBSTONE_THRESHOLD=10,delta_set={type:"DELTA_Set",propagation:CRDT.DELTA_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{add:function(e,t){if(objectsDebug&&console.warn("add",e,t,arguments),!this.state.adds.contains(e)){this.state.adds.set(e,new ALMap);var o=this.state.adds.get(e);return o.set(t,!0),{add:e}}},remove:function(e,t){var o=null,n=this.state.adds.get(e);if(n){for(var r={element:e,removes:n.keys()},s=0;s<r.removes.length;s++)this.state.removes.set(t,r.removes[s]),n["delete"](r.removes[s]);0==n.size()&&(this.state.adds["delete"](r.element),o={remove:r.element})}if(this.state.removes.size()>=TOMBSTONE_THRESHOLD){for(var i={},a=this.getVersionVector(),c=Object.keys(a),s=0;s<c.length;s++)a[c[s]]>3&&(i[c[s]]=a[c[s]]-3);console.info(i),this.garbageCollect(i)}return o}},garbageCollect:function(e){for(var t=this.state.removes.keys(),o=0;o<t.length;o++){var n=this.state.removes.get(t[o]);(before(n,e)||before(JSON.parse(t[o]),e))&&this.state.removes["delete"](t[o])}for(var r=Object.keys(e),o=0;o<r.length;o++){var s=r[o];this.gcvv[s]?this.gcvv[s]=Math.max(e[s],this.gcvv[s]):this.gcvv[s]=e[s]}},getDelta:function(e,t){for(var o={has:!1,adds:[],removes:[]},n=!1,r=Object.keys(e),s=0;s<r.length;s++)if(before({id:r[s],o:e[r[s]]},this.gcvv)){console.warn("from < gcvv"),n=!0;break}for(var i=this.state.adds.keys(),a=0;a<i.length;a++)for(var c=this.state.adds.get(i[a]),l=c.keys(),p=0;p<l.length;p++){var h=JSON.parse(l[p]);(1==n||after(h,e))&&(o.adds.push({key:i[a],u:h}),o.has=!0)}for(var u=this.state.removes.keys(),g=0;g<u.length;g++){var d=this.state.removes.get(u[g]);(1==n||after(d,e)||after(JSON.parse(u[g]),e))&&(o.removes.push({key:u[g],u:d}),o.has=!0)}return o},applyDelta:function(e,t,o){var n=e.adds,r=e.removes;objectsDebug&&console.log("applyDelta"),objectsDebug&&console.log(e),objectsDebug&&console.log(t),objectsDebug&&console.log(o);for(var s=new ALMap,i=0;i<n.length;i++){var a=n[i];this.state.adds.contains(a.key)||this.state.adds.set(a.key,new ALMap);var c=this.state.adds.get(a.key);c.set(a.u,!0);var l=s.get(a.key);l||(l=new ALMap,s.set(a.key,l)),l.set(a.u,!0)}for(var p=0;p<r.length;p++){var h=r[p];this.state.removes.set(h.key,h.u)}for(var u=!1,t=Object.keys(this.getVersionVector()),i=0;i<t.length;i++){var g=this.getVersionVector()[t[i]];if(o[t[i]]&&o[t[i]]>g){u=!0;break}}for(var d=this.state.adds.keys(),f=0;f<d.length;f++){for(var c=this.state.adds.get(d[f]),v=c.keys(),y=0;y<v.length;y++){for(var p=0;p<r.length;p++)v[y]==r[p].u&&c["delete"](v[y]);if(u){var S=JSON.parse(v[y]);if(after(S,o));else if(s.contains(d[f])){var l=s.get(d[f]);l.contains(S)||c["delete"](v[y])}else c["delete"](v[y])}}0==c.size()&&this.state.adds["delete"](d[f])}}}};"undefined"!=typeof exports?exports.DELTA_Set=delta_set:CRDT_LIB.DELTA_Set=delta_set;var before=function(e,t){return t instanceof ALMap?t.contains(e.id)?t.get(e.id)>e.o:!1:t[e.id]?t[e.id]>e.o:!1},after=function(e,t){return t instanceof ALMap?t.contains(e.id)?t.get(e.id)<e.o:!0:t[e.id]?t[e.id]<e.o:!0};B2BOverlay.prototype.onClientConnection=function(e){var t=this;this.legion.generateMessage("P2PMeta",null,function(o){o.meta={server:!t.legion.bullyProtocol.amBullied(),peers:t.legion.overlay.peerCount()},e.send(o)}),setTimeout(function(){t.checkIfMustHaveServer()},2e3)},B2BOverlay.prototype.checkIfMustHaveServer=function(){this.legion.bullyProtocol.amBullied()?this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.close():this.legion.connectionManager.serverConnection||this.legion.connectionManager.startSignallingConnection()},B2BOverlay.prototype.onClientDisconnect=function(e){},B2BOverlay.prototype.onServerConnection=function(e){this.init(e)},B2BOverlay.prototype.onServerDisconnect=function(e){},B2BOverlay.prototype.init=function(e){var t=this;this.overlay.peerCount()>this.min||(0==this.overlay.peerCount()?this.legion.generateMessage("JoinRequest",null,function(o){o.N=t.initial_n,o.TTL=t.initial_ttl,e.send(o)}):this.legion.generateMessage("JoinRequest",null,function(o){o.N=t.max-t.overlay.peerCount(),o.TTL=t.initial_ttl,e.send(o)}))},B2BOverlay.prototype.onJoinRequest=function(e,t,o){if(this.overlay.peers.contains(e.sender))e.TTL--,e.N>0&&e.TTL>0&&this.legion.messagingAPI.propagateToN(e);else{var n=!1;if(this.overlay.peerCount()<this.min?n=!0:0==e.TTL?n=!0:this.overlay.peerCount()<this.max&&(this.legion.bullyProtocol.amBullied()&&Math.random()<1-this.RAND_VAL?n=!0:!this.legion.bullyProtocol.amBullied()&&Math.random()<this.RAND_VAL&&(n=!0)),n){var r=this;this.legion.generateMessage("JoinAnswer",null,function(t){t.destination=e.sender,o.isAlive()?o.send(t):r.legion.messagingAPI.broadcastMessage(t)})}n&&e.N--,e.TTL--,e.N>0&&e.TTL>0&&o instanceof PeerConnection&&this.legion.messagingAPI.propagateToN(e)}},B2BOverlay.prototype.onJoinAnswer=function(e,t,o){this.overlay.peers.contains(e.sender)||this.legion.connectionManager.connectPeer(e.sender)},B2BOverlay.prototype.removeBestPeer=function(){var e=this.getBestPeer();e||(e=this.overlay.getPeers(1),e.length()>0&&(e=e[0])),e.close()},B2BOverlay.prototype.getBestPeer=function(){for(var e=null,t=null,o=this.overlay.getPeers(this.overlay.peerCount()),n=0;n<o.length;n++)t?this.isBetterMeta(o[n].meta,t)&&(t=o[n].meta,e=o[n]):(t=o[n].meta,e=o[n]);return e},B2BOverlay.prototype.isBetterMeta=function(e,t){return e?t?e.peers>t.peers||e.server<t.server:!0:!1},B2BOverlay.prototype.sendP2PMeta=function(){var e=this;this.legion.generateMessage("P2PMeta",null,function(t){t.meta={server:!e.legion.bullyProtocol.amBullied(),peers:e.legion.overlay.peerCount()},e.legion.messagingAPI.broadcastMessage(t,[e.legion.connectionManager.serverConnection])})},B2BOverlay.prototype.gotP2PMeta=function(e,t,o){o.setMeta(e.meta)},"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var op_orMap={type:"OP_ORMap",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){for(var e={},t=this.state.adds.keys(),o=0;o<t.length;o++)e[t[o]]=this.state.adds.get(t[o]).keys();return e},operations:{set:{local:function(e,t){var o=generateUniqueIdentifier(),n=this.state.adds.get(e);if(!n)return{key:e,value:t,unique:o,removes:[]};if(1==n.size()&&n.contains(t))return null;for(var r=n.values(),s=[],i=0;i<r.length;i++)s=s.concat(r[i].keys());return{key:e,value:t,unique:o,removes:s}},remote:function(e){if(e.key){var t={},o=e.key,n=e.value,r=e.unique,s=new ALMap;s.setAll(e.removes,!0),this.state.removes.setAll(e.removes,!0);var i=this.state.adds.get(o);if(this.state.removes.contains(r));else if(i||(i=new ALMap,this.state.adds.set(o,i)),0==i.size()){var a=new ALMap;a.set(r,!0),i.set(n,a),t.add={key:o,value:n}}else if(i.contains(n))if(i.get(n)==r)console.error("Duplicate unique.");else{var a=i.get(n);a.set(r,!0)}else{var a=i.get(n);if(!a){var a=new ALMap;i.set(n,a)}a.set(r,!0),t.change={key:o,value:n}}t.removes=[];for(var c=i.keys(),l=0;l<c.length;l++){for(var p=i.get(c[l]).keys(),h=0;h<p.length;h++)s.contains(p[h])&&i.get(c[l])["delete"](p[h]);0==i.get(c[l]).size()&&(i["delete"](c[l]),t.removes.push({key:o,value:c[l]}))}return 0==i.size()&&this.state.adds["delete"](o),0==t.removes.length&&delete t.removes,t.change||t.add||t.removes?t:void 0}}},contains:{local:function(e){return null},remote:function(e){return this.state.adds.contains(e)}},get:{local:function(e){return null},remote:function(e){return this.state.adds.get(e).keys()}},keys:{local:function(e){return null},remote:function(e){return this.state.adds.keys()}},"delete":{local:function(e){var t=this.state.adds.get(e);if(t){for(var o=t.values(),n=[],r=0;r<o.length;r++)n=n.concat(o[r].keys());return{key:e,removes:n}}return null},remote:function(e){if(e.key){var t={},o=e.key,n=new ALMap;n.setAll(e.removes,!0),this.state.removes.setAll(e.removes,!0);var r=this.state.adds.get(o);t.removes=[];for(var s=r.keys(),i=0;i<s.length;i++){for(var a=r.get(s[i]).keys(),c=0;c<a.length;c++)n.contains(a[c])&&r.get(s[i])["delete"](a[c]);0==r.get(s[i]).size()&&(r["delete"](s[i]),t.removes.push({key:o,value:s[i]}))}return 0==r.size()&&this.state.adds["delete"](o),0==t.removes.length&&delete t.removes,t.removes?t:void 0}}}}}};"undefined"!=typeof exports?exports.OP_ORMap=op_orMap:CRDT_LIB.OP_ORMap=op_orMap,SimpleBully.prototype.setOnBullyCallback=function(e){this.callbacks.push(e)},SimpleBully.prototype.bullied=function(){for(var e=this.amBullied(),t=0;t<this.callbacks.length;t++)this.callbacks[t](e)},SimpleBully.prototype.onClientConnection=function(e){e.remoteID>this.legion.id&&this.legion.generateMessage(this.handlers.bully.type,null,function(t){"undefined"!=typeof bullyLog&&bullyLog&&console.log("Being immediate bully to",e.remoteID),e.send(t)})},SimpleBully.prototype.onClientDisconnect=function(e){},SimpleBully.prototype.onServerConnection=function(e){this.amBullied()||this.floodBully()},SimpleBully.prototype.onServerDisconnect=function(e){},SimpleBully.prototype.amBullied=function(){if(this.bully==this.legion.id.toString()||"TEMP_ID"==this.bully)return!1;var e=Date.now()-this.lastBullyMessage;return e<=this.bullyMustHaveInterval},SimpleBully.prototype.floodBully=function(){if(this.amBullied())"undefined"!=typeof bullyLog&&bullyLog&&console.log("My bully",this.bully,this.lastBullyMessage);else{this.bullied(),this.bully=this.legion.id.toString(),this.lastBullyMessage=Date.now();var e=this;this.legion.generateMessage(this.handlers.bully.type,null,function(t){for(var o=e.legion.overlay.getPeers(e.legion.overlay.peerCount()),n=0;n<o.length;n++)"undefined"!=typeof bullyLog&&bullyLog&&console.log("Being bully to",o[n].remoteID),o[n].send(t)})}},"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)+(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var op_orset={type:"OP_ORSet",propagation:CRDT.OP_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{add:{local:function(e){var t=generateUniqueIdentifier();return{element:e,unique:t}},remote:function(e){if(!this.state.removes.contains(e.unique)){this.state.adds.contains(e.element)||this.state.adds.set(e.element,new ALMap);var t=this.state.adds.get(e.element);if(!t.contains(e.unique))return t.set(e.unique,!0),{add:e.element}}}},remove:{local:function(e){var t=this.state.adds.get(e);if(!t)return{element:e,removes:[]};var o=t.keys();return{element:e,removes:o}},remote:function(e){if(0==e.removes.length)return{};for(var t=this.state.adds.get(e.element),o=0;o<e.removes.length;o++)this.state.removes.set(e.removes[o],!0),t&&t["delete"](e.removes[o]);return t&&0==t.size()?(this.state.adds["delete"](e.element),{remove:e.element}):void 0}}}}};"undefined"!=typeof exports?exports.OP_ORSet=op_orset:CRDT_LIB.OP_ORSet=op_orset,FloodMessaging.prototype.onMessage=function(e,t,o){(!t.destination||t.destination&&t.destination!=this.legion.id)&&(e instanceof PeerConnection?this.broadcastMessage(o,[e]):debug&&console.log("Not broadcasting: "+t.type,this.legion.id,t.sender))},FloodMessaging.prototype.sendTo=function(e,t){t.destination=e,this.broadcastMessage(t,[this.legion.connectionManager.serverConnection])},FloodMessaging.prototype.broadcastMessage=function(e,t,o){var n=this.legion.overlay.getPeers(this.legion.overlay.peerCount());if(e.destination)for(var r=0;r<n.length;r++)if(n[r].remoteID==e.destination)return void n[r].send(e);var s=n.length;o&&(s=2);for(var i=0,r=0;s>i&&r<n.length;r++)if(n[r].remoteID!=e.sender){for(var a=!0,c=0;a&&t&&c<t.length;c++)t[c]&&n[r].remoteID==t[c].remoteID&&(a=!1);a&&(n[r].send(e),i++)}var l=this.legion.connectionManager.serverConnection;if(l){for(var r=0;t&&r<t.length;r++)if(t[r]&&l.remoteID==t[r].remoteID)return;l.send(e)}},"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var state_counter={type:"STATE_Counter",propagation:CRDT.STATE_BASED,crdt:{base_value:{state:{dec:ALMap,inc:ALMap}},getValue:function(){for(var e=0,t=this.state.dec.keys(),o=this.state.inc.keys(),n=0;n<t.length;n++)e-=this.state.dec.get(t[n]);for(var r=0;r<o.length;r++)e+=this.state.inc.get(o[r]);return e},operations:{increment:function(e,t){return this.state.inc.contains(e)||this.state.inc.set(e,0),this.state.inc.set(e,this.state.inc.get(e)+t),t},decrement:function(e,t){return this.state.dec.contains(e)||this.state.dec.set(e,0),this.state.dec.set(e,this.state.dec.get(e)+t),-t}},merge:function(e,t){for(var o=t.dec.keys(),n=t.inc.keys(),r=0,s=0;s<o.length;s++){var i=e.dec.get(o[s]);i?(r+=e.dec.get(o[s])-t.dec.get(o[s]),e.dec.set(o[s],Math.max(e.dec.get(o[s]),t.dec.get(o[s])))):(e.dec.set(o[s],t.dec.get(o[s])),r-=t.dec.get(o[s]))}for(var s=0;s<n.length;s++){var i=e.inc.get(n[s]);i?(r-=e.inc.get(n[s])-t.inc.get(n[s]),e.inc.set(n[s],Math.max(e.inc.get(n[s]),t.inc.get(n[s])))):(e.inc.set(n[s],t.inc.get(n[s])),r+=t.inc.get(n[s]))}var a={};return a.mergeResult=e,a.stateChange=r,a},compare:function(e,t){var o=!1,n=!1,r=e.inc,s=t.inc,i=e.dec,a=t.dec;if((r.size()>s.size()||i.size()>a.size())&&(o=!0),(s.size()>r.size()||a.size()>i.size())&&(n=!0),o&&n)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(!o){for(var c=r.keys(),l=0;l<c.length;l++){var p=c[l];if(!s.contains(p))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(r.get(p)>s.get(p)){o=!0;break}}for(var h=i.keys(),l=0;l<h.length;l++){var p=h[l];if(!a.contains(p))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(i.get(p)>a.get(p)){o=!0;break}}}if(!n){for(var u=s.keys(),l=0;l<u.length;l++){var p=u[l];if(!r.contains(p))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(s.get(p)>r.get(p)){n=!0;break}}for(var g=a.keys(),l=0;l<g.length;l++){var p=g[l];if(!i.contains(p))return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(a.get(p)>i.get(p)){n=!0;break}}}return o&&!n?CRDT.STATE.COMPARE_RESPONSE.LOWER:!o&&n?CRDT.STATE.COMPARE_RESPONSE.HIGHER:o||n?CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:CRDT.STATE.COMPARE_RESPONSE.EQUALS},fromJSONString:function(e){for(var t={dec:new ALMap,inc:new ALMap},o=e.dec,n=e.inc,r=0;r<o.length;r++)t.dec.set(o[r][0],o[r][1]);for(var r=0;r<n.length;r++)t.inc.set(n[r][0],n[r][1]);return t},toJSONString:function(e){for(var t=e.dec.keys(),o=e.inc.keys(),n=[],r=[],s=0;s<t.length;s++)n.push([t[s],e.dec.get(t[s])]);for(var s=0;s<o.length;s++)r.push([o[s],e.inc.get(o[s])]);return{dec:n,inc:r}}}};"undefined"!=typeof exports?exports.STATE_Counter=state_counter:CRDT_LIB.STATE_Counter=state_counter,SimpleOverlay.prototype.onClientConnection=function(e){this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.socket.close(),this.floodJoin()},SimpleOverlay.prototype.onClientDisconnect=function(e){},SimpleOverlay.prototype.onServerConnection=function(e){this.init()},SimpleOverlay.prototype.onServerDisconnect=function(e){},SimpleOverlay.prototype.init=function(e){this.floodJoin()},SimpleOverlay.prototype.floodJoin=function(){this.overlay.getPeers(this.overlay.peerCount());if(!this.started){var e=this.legion.connectionManager.serverConnection;e||this.legion.bullyProtocol.amBullied()||this.legion.connectionManager.startSignallingConnection(),this.started=!0}var t=this;this.legion.generateMessage("ConnectToAnyNodesPlease",null,function(e){t.legion.messagingAPI.broadcastMessage(e)})},SimpleOverlay.prototype.handleJoin=function(e,t,o){console.log(e),this.legion.connectionManager.hasPeer(e.sender)||this.overlay.peerCount()<=1&&this.legion.connectionManager.connectPeer(e.sender),this.legion.messagingAPI.broadcastMessage(t,[o]),this.legion.bullyProtocol.amBullied()&&this.legion.connectionManager.serverConnection&&this.legion.connectionManager.serverConnection.close()},"undefined"==typeof generateUniqueIdentifier&&(generateUniqueIdentifier=function(){return(""+Math.random()).substr(2,8)+(""+Math.random()).substr(2,8)}),"undefined"!=typeof exports&&(CRDT=require("./../crdt.js"),CRDT=CRDT.CRDT,ALMap=require("./../ALMap.js"),ALMap=ALMap.ALMap);var state_set={type:"STATE_Set",propagation:CRDT.STATE_BASED,crdt:{base_value:{state:{adds:ALMap,removes:ALMap}},getValue:function(){return this.state.adds.keys()},operations:{add:function(e){if(!this.state.adds.contains(e)){this.state.adds.set(e,new ALMap);var t=this.state.adds.get(e);return t.set(generateUniqueIdentifier(),!0),{add:e}}},remove:function(e){var t=this.state.adds.get(e);if(t){for(var o={element:e,removes:t.keys()},n=0;n<o.removes.length;n++)this.state.removes.set(o.removes[n],!0),t["delete"](o.removes[n]);if(0==t.size())return this.state.adds["delete"](o.element),{remove:o.element}}}},merge:function(e,t){e.removes.setAll(t.removes.keys(),!0);for(var o={adds:[],removes:[]},n=t.adds.keys(),r=0;r<n.length;r++)for(var s=t.adds.get(n[r]),i=s.keys(),a=0;a<i.length;a++)if(e.removes.contains(i[a]));else{
var c=e.adds.get(n[r]);c||(c=new ALMap,e.adds.set(n[r],c),o.adds.push(n[r])),c.contains(i[a])||c.set(i[a],!0)}for(var l=e.adds.keys(),p=0;p<l.length;p++){for(var h=e.adds.get(l[p]),u=h.keys(),g=0;g<u.length;g++)e.removes.contains(u[g])&&h["delete"](u[g]);0==h.size()&&(o.removes.push(l[p]),e.adds["delete"](l[p]))}var d={};return d.mergeResult=e,d.stateChange=o,d},compare:function(e,t){var o=!1,n=!1,r=e.removes.keys(),s=t.removes.keys();if(r.length>s.length?o=!0:s.length>r.length&&(n=!0),!o)for(var i=0;i<r.length;i++)if(!t.removes.contains(r[i])){o=!0;break}if(o&&n)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;if(!n)for(var i=0;i<s.length;i++)if(!e.removes.contains(s[i])){n=!0;break}if(o&&n)return CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE;for(var a=e.adds.keys().concat(t.adds.keys()),i=0;i<a.length&&(!n||!o);i++){var c=e.adds.get(a[i]),l=t.adds.get(a[i]);if(c)if(l){for(var p=c.keys(),h=l.keys(),u=0;!o&&u<p.length;u++)l.contains(p[u])||(o=!0);for(var u=0;!n&&u<h.length;u++)c.contains(h[u])||(n=!0)}else o=!0;else n=!0}return o&&!n?CRDT.STATE.COMPARE_RESPONSE.LOWER:!o&&n?CRDT.STATE.COMPARE_RESPONSE.HIGHER:o||n?CRDT.STATE.COMPARE_RESPONSE.MUST_MERGE:CRDT.STATE.COMPARE_RESPONSE.EQUALS},fromJSONString:function(e){for(var t={adds:new ALMap,removes:new ALMap},o=e.adds,n=e.removes,r=0;r<o.length;r++){var s=o[r].key,i=o[r].us,a=new ALMap;a.setAll(i,!0),t.adds.set(s,a)}return t.removes.setAll(n,!0),t},toJSONString:function(e){for(var t={adds:[],removes:e.removes.keys()},o=e.adds.keys(),n=0;n<o.length;n++)t.adds.push({key:o[n],us:e.adds.get(o[n]).keys()});return t}}};"undefined"!=typeof exports?exports.STATE_Set=state_set:CRDT_LIB.STATE_Set=state_set;
